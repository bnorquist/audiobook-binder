# audiobook-binder

Convert multiple MP3 files into a single M4B audiobook with auto-detected chapter markers, cover art, and rich metadata.

## Prerequisites

- Python 3.9+
- ffmpeg (`brew install ffmpeg`)
- [uv](https://docs.astral.sh/uv/) (for project management)

## Installation

```bash
git clone <repo-url>
cd audiobook-binder
uv sync
```

This installs the `audiobook-binder` CLI command in the project's virtual environment. Run it with `uv run audiobook-binder` or activate the venv first.

## Usage

### Quick convert (no manifest)

```bash
audiobook-binder convert ./my-mp3s/ -o "My Book.m4b" --title "My Book" --author "Jane Author"
```

### Recommended workflow (with manifest)

```bash
# 1. Generate a manifest from your MP3 directory
audiobook-binder init ./my-mp3s/

# 2. Edit the manifest to fix chapter names, add metadata
vim ./my-mp3s/manifest.yml

# 3. Convert (manifest is auto-detected in the directory)
audiobook-binder convert ./my-mp3s/ -o "My Book.m4b"
```

### Preview without converting

```bash
audiobook-binder convert ./my-mp3s/ --dry-run
```

This prints the chapter map, metadata, and output settings without running ffmpeg.

## Commands

### `audiobook-binder init`

```
audiobook-binder init INPUT_PATH [-o OUTPUT]
```

Scans a directory for MP3 files, probes each for duration and ID3 tags, auto-detects a cover image, and writes a `manifest.yml` pre-filled with chapter names and metadata.

| Option | Description |
|--------|-------------|
| `-o, --output` | Output manifest path (default: `INPUT_PATH/manifest.yml`) |

### `audiobook-binder convert`

```
audiobook-binder convert INPUT_PATH [OPTIONS]
```

Converts MP3 files into a single M4B audiobook.

| Option | Description |
|--------|-------------|
| `-o, --output` | Output `.m4b` file path (default: `INPUT_PATH/{title}.m4b`) |
| `--title` | Book title |
| `--author` | Author name |
| `--narrator` | Narrator name |
| `--series` | Series name |
| `--year` | Publication year |
| `--genre` | Genre (default: `Audiobook`) |
| `--description` | Book description |
| `--cover` | Path to cover image (jpg/png) |
| `--manifest` | Path to YAML manifest |
| `--dry-run` | Show chapter map and metadata without converting |
| `--verbose` | Show ffmpeg output |

CLI flags override manifest values.

## Manifest format

The manifest is a YAML file that controls file ordering, chapter names, and book metadata. Generated by `audiobook-binder init`, meant to be edited by hand.

```yaml
# Generated by: audiobook-binder init ./my-mp3s
# Edit this file to customize your audiobook, then run:
#   audiobook-binder convert ./my-mp3s

title: "The Great Novel"
author: "Jane Author"
narrator: ""
series: ""
year: "2024"
genre: "Audiobook"
description: ""
cover: "cover.jpg"

chapters:
  - file: "01_intro.mp3"
    title: "Introduction"
    duration: "5:23"          # read-only reference, not used in conversion

  - file: "02_chapter1.mp3"
    title: "The Journey Begins"
    duration: "32:07"

  - file: "03_chapter2.mp3"
    title: "Chapter 2"
    duration: "28:45"
```

### Chapter name resolution

Chapter names are resolved in priority order:

1. Manifest `title` field (if a manifest is present)
2. MP3 ID3 title tag
3. Cleaned filename (strips numbering prefixes and extensions)

### Bitrate strategy

The output AAC bitrate matches the highest input MP3 bitrate, floored at 64 kbps and capped at 256 kbps. AAC is roughly 30% more efficient than MP3, so same-bitrate encoding preserves quality.

## Development

```bash
# Run tests
uv run pytest tests/ -v

# Run a single test file
uv run pytest tests/test_metadata.py -v
```
